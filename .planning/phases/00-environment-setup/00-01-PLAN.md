---
phase: 00-environment-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - flake.nix
  - .envrc
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "`nix develop` provides a shell with Python 3.12, uv, ruff, and cmake in PATH"
    - "`uv sync` installs all Python packages without errors"
    - "`python -c 'import lightgbm'` succeeds without libgomp.so.1 errors"
    - "direnv activates the flake environment automatically on directory entry"
  artifacts:
    - path: "flake.nix"
      provides: "Nix devShell with Python 3.12 + system dependencies"
      contains: "python312"
    - path: ".envrc"
      provides: "direnv integration"
      contains: "use flake"
    - path: "pyproject.toml"
      provides: "Python project definition with all dependencies"
      contains: "polars"
  key_links:
    - from: "flake.nix"
      to: "LD_LIBRARY_PATH"
      via: "env attribute in mkShell"
      pattern: "LD_LIBRARY_PATH"
    - from: "flake.nix"
      to: "libgcc.lib"
      via: "runtimeLibs list"
      pattern: "libgcc"
    - from: "pyproject.toml"
      to: "uv sync"
      via: "dependencies list"
      pattern: "dependencies"
---

<objective>
Create the Nix flake, direnv integration, and pyproject.toml that together provide a fully reproducible Python 3.12 development environment with all ML dependencies.

Purpose: This is the foundation for the entire project. Without a working environment, nothing else can proceed.
Output: Three files (flake.nix, .envrc, pyproject.toml) that enable `nix develop && uv sync` to produce a working ML environment.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/00-environment-setup/00-RESEARCH.md
@.planning/phases/00-environment-setup/00-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create flake.nix with Python 3.12 devShell</name>
  <files>flake.nix, .envrc</files>
  <action>
Create `flake.nix` at the project root with:

**Inputs:**
- `nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.05"` (latest stable, NixOS 25.05 "Warbler")

**devShell packages:**
- `python312` — Python 3.12 interpreter
- `uv` — Python package manager
- `ruff` — Python linter/formatter
- `cmake` — Build system for LightGBM/XGBoost source builds

**LD_LIBRARY_PATH (CRITICAL for NixOS):**
Build a `runtimeLibs` list containing:
- `stdenv.cc.cc.lib` — provides `libstdc++.so.6` (needed by compiled wheels)
- `libgcc.lib` — provides `libgomp.so.1` (OpenMP runtime for LightGBM)
- `zlib` — provides `libz.so` (needed by numpy, polars wheels)

Set via `env.LD_LIBRARY_PATH = pkgs.lib.makeLibraryPath runtimeLibs;`

**shellHook:**
Brief welcome message showing Python version, uv version, and a hint to run `uv sync`.

**System attribute:** `x86_64-linux` only (user's platform).

Create `.envrc` with a single line: `use flake`

This enables direnv to automatically activate the Nix devShell when entering the directory (per user's CLAUDE.md preference for `direnv reload` workflow).

**IMPORTANT:** The existing .gitignore has `.envrc` listed. Plan 00-02 will fix this. Do NOT modify .gitignore in this task.
  </action>
  <verify>
Run `nix flake check` to verify flake syntax.
Run `nix develop --command bash -c "python3 --version && uv --version && ruff --version && cmake --version"` to verify all tools are available.
Confirm `.envrc` contains `use flake`.
  </verify>
  <done>
`nix develop` provides Python 3.12.x, uv, ruff, and cmake. LD_LIBRARY_PATH includes paths to libstdc++, libgomp, and zlib. `.envrc` exists with `use flake`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pyproject.toml with all Python dependencies</name>
  <files>pyproject.toml</files>
  <action>
Create `pyproject.toml` at the project root with:

**Project metadata:**
```toml
[project]
name = "alerta-escuela-audit"
version = "0.1.0"
description = "Independent equity audit of Peru's Alerta Escuela dropout prediction system"
requires-python = ">=3.12"
license = "MIT"
```

**Dependencies (ALL from spec Section 2 + CONTEXT.md additions):**
```toml
dependencies = [
    "polars>=1.0",
    "scikit-learn>=1.5",
    "lightgbm>=4.0",
    "xgboost>=2.0",
    "fairlearn>=0.11",
    "shap>=0.45",
    "statsmodels",
    "matplotlib",
    "seaborn",
    "plotly",
    "onnx",
    "onnxmltools",
    "onnxruntime",
    "pytest",
    "jupyterlab",
    "optuna",
    "enahodata",
    "requests",
    "tqdm",
]
```

**Build system:**
```toml
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.backends"
```

Use compatible version ranges (`>=X.Y`) as specified in the tech stack — uv lock file handles reproducibility. Do NOT use exact pins.

After creating the file, run `uv sync` inside the nix develop shell to generate `uv.lock` and install all packages.

Then verify critical imports work:
```bash
nix develop --command bash -c "uv sync && uv run python -c 'import polars; import lightgbm; import xgboost; import fairlearn; import shap; import optuna; import onnxmltools; import onnxruntime; print(\"All imports OK\")'"
```
  </action>
  <verify>
`uv sync` completes without errors.
`uv.lock` file is generated.
`uv run python -c "import polars; import lightgbm; import xgboost; import fairlearn; import shap; import optuna"` succeeds.
LightGBM specifically imports without `libgomp.so.1` or `libstdc++.so.6` errors.
  </verify>
  <done>
pyproject.toml declares all 19 Python dependencies. `uv sync` resolves and installs them. All critical ML libraries import successfully inside the Nix shell. `uv.lock` exists and is tracked.
  </done>
</task>

</tasks>

<verification>
1. `nix develop --command bash -c "python3 --version"` → Python 3.12.x
2. `nix develop --command bash -c "uv sync && uv run python -c 'import lightgbm; import xgboost; import fairlearn; import shap; import polars; import optuna; import onnxmltools; import onnxruntime; print(\"SUCCESS\")"'` → SUCCESS
3. `cat .envrc` → `use flake`
4. `grep -c "polars" pyproject.toml` → at least 1 match
5. `test -f uv.lock` → exists
</verification>

<success_criteria>
- `nix develop` provides Python 3.12, uv, ruff, cmake
- `uv sync` installs all 19 Python dependencies without errors
- All critical ML imports succeed (polars, lightgbm, xgboost, fairlearn, shap, optuna, onnxmltools, onnxruntime)
- LightGBM works on NixOS (no missing shared library errors)
- `.envrc` enables direnv integration
- `uv.lock` generated and tracked
</success_criteria>

<output>
After completion, create `.planning/phases/00-environment-setup/00-01-SUMMARY.md`
</output>
