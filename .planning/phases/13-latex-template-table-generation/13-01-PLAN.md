# Plan 13-01: LaTeX Template + Table Generation

## Goal
Create ACM-format LaTeX paper template with 8 auto-generated tables from JSON exports, all figures included, and paper structure with placeholder text.

## Pre-conditions
- All v1.0 JSON exports exist in `data/exports/` (6 files)
- Publication figures exist in `paper/figures/` (7 figures × PNG+PDF)
- Python environment with json, pathlib available (standard library)

---

## Tasks

### Task 1: Add texlive to flake.nix
**File:** `flake.nix` (edit)
**What:** Add texlive packages to the development shell so `pdflatex`/`latexmk` are available.
**Details:**
- Add `texlive.combined.scheme-medium` to `buildInputs` (includes acmart, booktabs, siunitx, natbib, hyperref, graphicx, xcolor)
- Add `latexmk` if not bundled with scheme-medium
- Run `direnv reload` to activate
- Verify: `pdflatex --version` and `latexmk --version` succeed

### Task 2: Create paper/main.tex template
**File:** `paper/main.tex` (new)
**What:** ACM acmart template with full paper structure, figure includes, and table input stubs.
**Details:**
- Document class: `\documentclass[acmsmall,nonacm]{acmart}` (nonacm for preprint without ACM copyright)
- Packages: `booktabs`, `siunitx`, `graphicx`, `xcolor`, `hyperref`, `subcaption`
- Title: "Equity Audit of Peru's Alerta Escuela Early Warning System: Who Gets Missed?"
- Authors: placeholder (user fills in)
- Abstract: 150-word placeholder summarizing key findings (FNR=63%, indigenous surveillance bias, spatial-structural predictors)
- Keywords: educational equity, dropout prediction, algorithmic fairness, Peru, ENAHO
- 8 sections with `\section{}` headers and 2-3 sentence placeholder text per section explaining what goes there
- Figure includes for all 7 figures from `paper/figures/` with `\includegraphics`, captions, and `\label{fig:XX}`
- Table includes via `\input{tables/table_XX.tex}` for all 8 tables with surrounding `\begin{table}` environments, captions, and `\label{tab:XX}`
- Bibliography: `\bibliographystyle{ACM-Reference-Format}` with `paper/references.bib`
- Place figures and tables in their natural sections:
  - Section 3 (Data): T1 sample, T2 language dropout, T3 region/poverty, Fig04 dropout heatmap
  - Section 5 (Results): T4 model comparison, T5 LR coefficients, Fig01 PR curves, Fig02 calibration
  - Section 6 (Fairness): T6 fairness by language, T7 intersection, T8 SHAP, Fig03 FNR/FPR bar, Fig05 FNR heatmap, Fig06 SHAP bar, Fig07 SHAP beeswarm
- Appendix: placeholder for supplementary tables

### Task 3: Create paper/references.bib
**File:** `paper/references.bib` (new)
**What:** BibTeX entries for key references.
**Details:**
- Include entries for:
  - Alerta Escuela / MINEDU early warning system references
  - ENAHO survey methodology (INEI)
  - fairlearn library
  - SHAP (Lundberg & Lee 2017)
  - LightGBM (Ke et al. 2017)
  - Key equity in ML papers (Barocas & Selbst, Chouldechova)
  - Peru education statistics (MINEDU/UNESCO)
- ~15-20 entries, properly formatted BibTeX
- Placeholder `\cite{}` commands in main.tex sections

### Task 4: Create table generation script
**File:** `scripts/generate_tables.py` (new)
**What:** Python script that reads all JSON exports and generates 8 LaTeX table files.
**Details:**
- Load JSON files from `data/exports/` using `json` and `pathlib`
- For each table, generate a standalone `.tex` file containing just the `tabular` environment (no `\begin{table}` wrapper — that's in main.tex)
- Output directory: `paper/tables/`
- Number formatting: 3 decimal places for rates/metrics, 0 decimal for counts, parentheses for CIs
- Small sample annotation: asterisk (*) for n < 100

**Table specifications:**

**T1 — Sample Description (`table_01_sample.tex`)**
- Source: `descriptive_tables.json` → `_metadata` + dimension arrays
- Columns: Dimension, Category, n (unweighted), n (weighted), Dropout Rate
- Rows: Overall + Language (7 groups) + Sex (2) + Geography (2) + Region (3) = ~15 rows
- Use `\midrule` between dimension groups

**T2 — Dropout by Language Group (`table_02_language.tex`)**
- Source: `descriptive_tables.json` → `language`
- Columns: Language Group, Weighted Rate, [95% CI], n (unweighted)
- 7 rows sorted by rate descending
- Spanish group names: Awajún, Asháninka, Otros indígenas, Quechua, Aimara, Castellano, Extranjero
- Bold the highest rate

**T3 — Dropout by Region and Poverty (`table_03_region_poverty.tex`)**
- Source: `descriptive_tables.json` → `region` + `poverty`
- Panel A (3 rows): Region — Costa, Sierra, Selva with rate + CI
- Panel B (5 rows): Poverty Quintile — Q1 (poorest) to Q5 with rate + CI
- Use `\midrule` between panels

**T4 — Model Performance Comparison (`table_04_models.tex`)**
- Source: `model_results.json` → 3 model keys
- Columns: Metric, Logistic Regression, LightGBM, XGBoost
- Rows: PR-AUC (val), PR-AUC (test), ROC-AUC (val), ROC-AUC (test), F1 (test), Precision (test), Recall (test)
- Use `validate_2022.weighted` for val, `test_2023.weighted` for test (except LightGBM test uses `test_2023_calibrated`)
- Bold the best value per row

**T5 — Logistic Regression Coefficients (`table_05_lr_coefficients.tex`)**
- Source: `model_results.json` → `logistic_regression.coefficients`
- Columns: Feature (Spanish name), Coefficient, Odds Ratio, Direction
- All 25 features sorted by |coefficient| descending
- Use SHAP's `feature_labels_es` from `shap_values.json` for Spanish names
- Direction column: ↑ for positive (increases dropout risk), ↓ for negative

**T6 — Fairness Metrics by Language (`table_06_fairness_language.tex`)**
- Source: `fairness_metrics.json` → `dimensions.language.groups`
- Columns: Language Group, n, FNR, FPR, Precision, PR-AUC
- 6 rows (drop "unknown" — unreliable per Phase 8 notes), sorted by FNR ascending
- Asterisk (*) for groups with n < 100
- Highlight FNR > 0.5 in bold (the "invisible" groups)
- Last row: Max Gap (from `gaps` object)

**T7 — Intersection: Language × Rurality (`table_07_intersection.tex`)**
- Source: `fairness_metrics.json` → `intersections.language_x_rural.groups`
- Matrix format: rows = language groups, columns = Urban FNR, Rural FNR, Urban n, Rural n
- Asterisk for n < 100
- Highlight the other_indigenous_urban cell (FNR=0.753) — the key finding
- Note at bottom: "* n < 100; interpret with caution"

**T8 — SHAP Feature Importance (`table_08_shap.tex`)**
- Source: `shap_values.json` → `global_importance` + `top_5_lr`
- Columns: Rank, Feature (Spanish), Mean |SHAP|, LR Rank
- Top 15 features by SHAP importance
- LR Rank column shows where the same feature ranks in logistic regression (highlights paradigm difference)
- Note: "SHAP computed on uncalibrated LightGBM; values in log-odds space"

### Task 5: Run table generation and verify
**What:** Execute the script, verify output, compile LaTeX.
**Details:**
- Run: `uv run python scripts/generate_tables.py`
- Verify 8 `.tex` files created in `paper/tables/`
- Compile: `cd paper && latexmk -pdf main.tex`
- Verify PDF is produced and opens correctly
- Spot-check 5 cells per table against source JSON

### Task 6: Gate tests
**File:** `tests/test_gate_latex_tables.py` (new)
**What:** Verify table generation correctness and LaTeX template integrity.
**Tests:**
1. `paper/main.tex` exists and contains `\documentclass`
2. `paper/references.bib` exists and contains at least 10 `@` entries
3. All 8 table files exist in `paper/tables/`
4. Each table file contains `\begin{tabular}` and `\end{tabular}`
5. T2 spot-check: castellano weighted_rate matches `descriptive_tables.json` → `language` (find castellano group) within 0.001
6. T4 spot-check: LightGBM val PR-AUC matches `model_results.json` → `lightgbm.metrics.validate_2022.weighted.pr_auc` within 0.001
7. T6 spot-check: castellano FNR matches `fairness_metrics.json` → `dimensions.language.groups.castellano.fnr` within 0.001
8. T8 spot-check: top SHAP feature is "age" and mean |SHAP| matches `shap_values.json` → `global_importance.age` within 0.001
9. T7 spot-check: other_indigenous_urban FNR > 0.7 (from source data)
10. All figure references in main.tex have corresponding files in `paper/figures/`
11. `scripts/generate_tables.py` runs without errors: `uv run python scripts/generate_tables.py`
12. No hardcoded metric values in table .tex files (all generated from JSON — verify script produces identical output on re-run)

---

## Execution Notes

- `mkdir -p paper/tables/` at script start
- Table .tex files are `\input`-able fragments (tabular only, no table float wrapper)
- Script should be idempotent — re-running overwrites with identical output
- Spanish names for features come from `shap_values.json` → `feature_labels_es`
- Gate tests run with `uv run pytest tests/test_gate_latex_tables.py -v`

## Commit Plan
Single commit after tables generated, LaTeX compiles, and gate tests pass:
```
feat(13-01): LaTeX template + 8 auto-generated tables from JSON exports
```
